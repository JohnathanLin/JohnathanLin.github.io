<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>一个被废弃的项目——自动爬取信息然后发给我自己邮箱上 | 风萧古道 - 勤学苦练，年复一年</title><meta name=keywords content><meta name=description content="这是一个python项目。
使用到的技术包括爬虫和发邮件
代码如下：
#!/usr/bin/env python # -*- coding: utf-8 -*- # @Time : 2020/2/5 22:49 # @Author : Johnathan Lin import time import requests import random import json import re from bs4 import BeautifulSoup import smtplib from email.mime.text import MIMEText from email.header import Header from urllib.parse import urljoin from bs4.element import NavigableString # 第三方 SMTP 服务 mail_host = &#34;smtp.163.com&#34; # 设置服务器 mail_user = &#34;你的邮箱&#34; # 用户名 mail_pass = &#34;你的密码&#34; # 口令 # 发送人和接收人 sender = '你的邮箱' # 自己发给自己就可以了， receivers = ['你的邮箱'] # 接收邮件，可设置为你的QQ邮箱或者其他邮箱 # 爬虫请求头 headers = { 'User-Agent': 'Mozilla/5."><meta name=author content="JohnathanLin"><link rel=canonical href=https://windypath.com/posts/a_bad_project_crawler_and_email/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.bc1149f4a72aa4858d3a9f71462f75e5884ffe8073ea9d6d5761d5663d651e20.css integrity="sha256-vBFJ9KcqpIWNOp9xRi915YhP/oBz6p1tV2HVZj1lHiA=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://windypath.com/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=https://windypath.com/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://windypath.com/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://windypath.com/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://windypath.com/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://windypath.com/posts/a_bad_project_crawler_and_email/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-123-45","auto"),ga("send","pageview"))</script><meta property="og:title" content="一个被废弃的项目——自动爬取信息然后发给我自己邮箱上"><meta property="og:description" content="这是一个python项目。
使用到的技术包括爬虫和发邮件
代码如下：
#!/usr/bin/env python # -*- coding: utf-8 -*- # @Time : 2020/2/5 22:49 # @Author : Johnathan Lin import time import requests import random import json import re from bs4 import BeautifulSoup import smtplib from email.mime.text import MIMEText from email.header import Header from urllib.parse import urljoin from bs4.element import NavigableString # 第三方 SMTP 服务 mail_host = &#34;smtp.163.com&#34; # 设置服务器 mail_user = &#34;你的邮箱&#34; # 用户名 mail_pass = &#34;你的密码&#34; # 口令 # 发送人和接收人 sender = '你的邮箱' # 自己发给自己就可以了， receivers = ['你的邮箱'] # 接收邮件，可设置为你的QQ邮箱或者其他邮箱 # 爬虫请求头 headers = { 'User-Agent': 'Mozilla/5."><meta property="og:type" content="article"><meta property="og:url" content="https://windypath.com/posts/a_bad_project_crawler_and_email/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-02-09T17:21:03+08:00"><meta property="article:modified_time" content="2020-02-09T17:21:03+08:00"><meta property="og:site_name" content="风萧古道 - 勤学苦练，年复一年"><meta name=twitter:card content="summary"><meta name=twitter:title content="一个被废弃的项目——自动爬取信息然后发给我自己邮箱上"><meta name=twitter:description content="这是一个python项目。
使用到的技术包括爬虫和发邮件
代码如下：
#!/usr/bin/env python # -*- coding: utf-8 -*- # @Time : 2020/2/5 22:49 # @Author : Johnathan Lin import time import requests import random import json import re from bs4 import BeautifulSoup import smtplib from email.mime.text import MIMEText from email.header import Header from urllib.parse import urljoin from bs4.element import NavigableString # 第三方 SMTP 服务 mail_host = &#34;smtp.163.com&#34; # 设置服务器 mail_user = &#34;你的邮箱&#34; # 用户名 mail_pass = &#34;你的密码&#34; # 口令 # 发送人和接收人 sender = '你的邮箱' # 自己发给自己就可以了， receivers = ['你的邮箱'] # 接收邮件，可设置为你的QQ邮箱或者其他邮箱 # 爬虫请求头 headers = { 'User-Agent': 'Mozilla/5."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://windypath.com/posts/"},{"@type":"ListItem","position":2,"name":"一个被废弃的项目——自动爬取信息然后发给我自己邮箱上","item":"https://windypath.com/posts/a_bad_project_crawler_and_email/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"一个被废弃的项目——自动爬取信息然后发给我自己邮箱上","name":"一个被废弃的项目——自动爬取信息然后发给我自己邮箱上","description":"这是一个python项目。\n使用到的技术包括爬虫和发邮件\n代码如下：\n#!/usr/bin/env python # -*- coding: utf-8 -*- # @Time : 2020/2/5 22:49 # @Author : Johnathan Lin import time import requests import random import json import re from bs4 import BeautifulSoup import smtplib from email.mime.text import MIMEText from email.header import Header from urllib.parse import urljoin from bs4.element import NavigableString # 第三方 SMTP 服务 mail_host = \u0026#34;smtp.163.com\u0026#34; # 设置服务器 mail_user = \u0026#34;你的邮箱\u0026#34; # 用户名 mail_pass = \u0026#34;你的密码\u0026#34; # 口令 # 发送人和接收人 sender = \u0026#39;你的邮箱\u0026#39; # 自己发给自己就可以了， receivers = [\u0026#39;你的邮箱\u0026#39;] # 接收邮件，可设置为你的QQ邮箱或者其他邮箱 # 爬虫请求头 headers = { \u0026#39;User-Agent\u0026#39;: \u0026#39;Mozilla/5.","keywords":[],"articleBody":"这是一个python项目。\n使用到的技术包括爬虫和发邮件\n代码如下：\n#!/usr/bin/env python # -*- coding: utf-8 -*- # @Time : 2020/2/5 22:49 # @Author : Johnathan Lin import time import requests import random import json import re from bs4 import BeautifulSoup import smtplib from email.mime.text import MIMEText from email.header import Header from urllib.parse import urljoin from bs4.element import NavigableString # 第三方 SMTP 服务 mail_host = \"smtp.163.com\" # 设置服务器 mail_user = \"你的邮箱\" # 用户名 mail_pass = \"你的密码\" # 口令 # 发送人和接收人 sender = '你的邮箱' # 自己发给自己就可以了， receivers = ['你的邮箱'] # 接收邮件，可设置为你的QQ邮箱或者其他邮箱 # 爬虫请求头 headers = { 'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/77.0.3865.90 Safari/537.36' } def send_mail(date, msg): \"\"\" 发送邮件 :param date: 日期 :param msg: XX内容 :return: \"\"\" mail_msg = msg message = MIMEText(mail_msg, 'html', 'utf-8') message['From'] = Header(\"我的发件邮箱\", 'utf-8') message['To'] = Header(\"我的收件邮箱\", 'utf-8') subject = date + ' ' + 'XXXXXXX情况' message['Subject'] = Header(subject, 'utf-8') try: smtpObj = smtplib.SMTP() smtpObj.connect(mail_host, 25) # 25 为 SMTP 端口号 smtpObj.login(mail_user, mail_pass) smtpObj.sendmail(sender, receivers, message.as_string()) print(\"邮件发送成功\") except smtplib.SMTPException as e: print(\"Error: 无法发送邮件\") print(repr(e)) def regular_res(res): \"\"\" 把不规则json转为规则json :param res: 请求得到的字符串 :return: 合法的json字符串 \"\"\" res = re.sub(r'\\n', '', res) res = re.sub(r'\\t', '', res) res = re.sub(r'chnldesc', '\\\"chnldesc\\\"', res) res = re.sub(r'recordCount', '\\\"recordCount\\\"', res) res = re.sub(r'docs', '\\\"docs\\\"', res) res = re.sub(r'docid', '\\\"docid\\\"', res) res = re.sub(r'title', '\\\"title\\\"', res) res = re.sub(r'url', '\\\"url\\\"', res) res = re.sub(r'time ', '\\\"time\\\"', res) return res def crawl_data(date): \"\"\" 爬取文档 :param date: 日期，用于测量是否是当天的 :return: 目标页面的url \"\"\" url = 'http://xxxxxxxxxx?r=' + str(random.random()) response = requests.get(url, headers=headers) res = str(response.content, encoding='utf-8') response.close() res = regular_res(res) json_obj = json.loads(res) for doc in json_obj['docs']: if doc['title'] == 'XXXXXXXX情情况' and doc['time'] == date: return doc['url'] return '' def timestamp_to_date(timestamp): \"\"\" 时间戳转时间年-月-日 :param timestamp: 时间戳 :return: 时间字符串 \"\"\" return time.strftime(time.strftime(\"%Y-%m-%d\", time.localtime(timestamp))) def crawl_content(res_url): response = requests.get(res_url, headers=headers) html = str(response.content, encoding='utf-8') response.close() html_content = BeautifulSoup(html, 'lxml') news_content = '' news_block = html_content.select('div.TRS_Editor')[0] [s.extract() for s in html_content.select('style')] [s.extract() for s in html_content.select('script')] for block in news_block.contents: if not isinstance(block, NavigableString): del block['style'] del block['class'] del block['align'] # print(block.name) if block.name == 'a': block['href'] = urljoin(res_url, block['href']) if block.name == 'h2' or block.get_text().strip() == '': continue news_content += str(block).replace('\\r', '').replace('\\n', '').replace('\\t', '').strip() return news_content if __name__ == '__main__': # # 2.6的时间戳 timestamp = 1580918400 while (True): # 每隔60秒爬一次 time.sleep(60) # 获取下次需要的日期 date = timestamp_to_date(timestamp) # 请求得到目标url res_url = crawl_data(date) if res_url == '': continue # 找到相应的请求，爬取内容 news_content = crawl_content(res_url) # 发送邮件 send_mail(date, news_content) # 爬取下一天的内容 timestamp += 86400 # 2.9之后停止 if timestamp == 1581264000: break 使用网易邮箱app，可以第一时间接到自己发的邮件。\n这里测试过QQ邮箱，把我的邮件判定为垃圾邮件，直接被退回了。\n测试结果： （我做完然后发现爬不动的时候，感觉到了自己在吃人血馒头，故将人名隐去）\n在本地测试通过后，放到服务器上，使用\nnohup python3 main.py \u0026 放在后台执行，本以为万事大吉，结果才爬了一小会人报了错。\nConnectionResetError: [Errno 104] Connection reset by peer 服务器把我的连接请求关闭了。\n网上查找资料的结果是，爬取过频，对面关闭服务器我还继续请求。\n但我一分钟请求一次，也不算特别快了。\n我当然可以写个方法，在读取异常之后继续爬，如：\ndef request_while_response(url, type, headers, data, open_proxy, sleep_time): \"\"\" 发送请求,规避10054错误，直至请求成功 :param url: 请求路径 :param type: 请求类型（get或post） :param headers: 请求头 :param data: 请求参数对象 :param open_proxy: 是否使用代理 :return: 请求得到的文本 \"\"\" r = '' while True: # 循环 try: # request()是发送请求的方法，我将requests包封装成了 r = request(url, type, headers, data, open_proxy) except (requests.exceptions.SSLError, requests.exceptions.ConnectionError, requests.exceptions.ReadTimeout) as e: if 'bad handshake' in str(e) or '10054' in str(e) or 'Read timed out' in str(e): # 上述2种异常 time.sleep(sleep_time) continue # 继续发请求 else: raise Exception(e) # 其他异常，抛出来 break # 无异常就跳出循环 return r # 返回响应结果 但总归是做贼心虚，还是罢了。\n","wordCount":"512","inLanguage":"zh","datePublished":"2020-02-09T17:21:03+08:00","dateModified":"2020-02-09T17:21:03+08:00","author":{"@type":"Person","name":"JohnathanLin"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://windypath.com/posts/a_bad_project_crawler_and_email/"},"publisher":{"@type":"Organization","name":"风萧古道 - 勤学苦练，年复一年","logo":{"@type":"ImageObject","url":"https://windypath.com/%3Clink%20/%20abs%20url%3E"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://windypath.com/ accesskey=h title="风萧古道 (Alt + H)">风萧古道</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://windypath.com/en/ title="Switch to English Page" aria-label="Switch to English Page">En</a></li></ul></div></div><ul id=menu><li><a href=https://windypath.com/archives/ title=归档><span>归档</span></a></li><li><a href=https://windypath.com/categories/ title=分类><span>分类</span></a></li><li><a href=https://windypath.com/tags/ title=标签><span>标签</span></a></li><li><a href=https://windypath.com/about/ title=关于><span>关于</span></a></li><li><a href=https://windypath.com/search/ title="搜索 (Alt + /)" accesskey=/><span>搜索</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>一个被废弃的项目——自动爬取信息然后发给我自己邮箱上</h1><div class=post-meta><span title='2020-02-09 17:21:03 +0800 +0800'>二月 9, 2020</span>&nbsp;·&nbsp;JohnathanLin</div></header><div class=post-content><p>这是一个python项目。</p><p>使用到的技术包括爬虫和发邮件</p><p>代码如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e>#!/usr/bin/env python</span>
</span></span><span style=display:flex><span><span style=color:#75715e># -*- coding: utf-8 -*-</span>
</span></span><span style=display:flex><span><span style=color:#75715e># @Time    : 2020/2/5 22:49</span>
</span></span><span style=display:flex><span><span style=color:#75715e># @Author  : Johnathan Lin</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> time
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> requests
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> random
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> json
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> re
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> bs4 <span style=color:#f92672>import</span> BeautifulSoup
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> smtplib
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> email.mime.text <span style=color:#f92672>import</span> MIMEText
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> email.header <span style=color:#f92672>import</span> Header
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> urllib.parse <span style=color:#f92672>import</span> urljoin
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> bs4.element <span style=color:#f92672>import</span> NavigableString
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 第三方 SMTP 服务</span>
</span></span><span style=display:flex><span>mail_host <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;smtp.163.com&#34;</span>  <span style=color:#75715e># 设置服务器</span>
</span></span><span style=display:flex><span>mail_user <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;你的邮箱&#34;</span>  <span style=color:#75715e># 用户名</span>
</span></span><span style=display:flex><span>mail_pass <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;你的密码&#34;</span>  <span style=color:#75715e># 口令</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 发送人和接收人</span>
</span></span><span style=display:flex><span>sender <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;你的邮箱&#39;</span> <span style=color:#75715e># 自己发给自己就可以了，</span>
</span></span><span style=display:flex><span>receivers <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#39;你的邮箱&#39;</span>]  <span style=color:#75715e># 接收邮件，可设置为你的QQ邮箱或者其他邮箱</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 爬虫请求头</span>
</span></span><span style=display:flex><span>headers <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;User-Agent&#39;</span>: <span style=color:#e6db74>&#39;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/77.0.3865.90 Safari/537.36&#39;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>send_mail</span>(date, msg):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    发送邮件
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    :param date: 日期
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    :param msg: XX内容
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    :return:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    mail_msg <span style=color:#f92672>=</span> msg
</span></span><span style=display:flex><span>    message <span style=color:#f92672>=</span> MIMEText(mail_msg, <span style=color:#e6db74>&#39;html&#39;</span>, <span style=color:#e6db74>&#39;utf-8&#39;</span>)
</span></span><span style=display:flex><span>    message[<span style=color:#e6db74>&#39;From&#39;</span>] <span style=color:#f92672>=</span> Header(<span style=color:#e6db74>&#34;我的发件邮箱&#34;</span>, <span style=color:#e6db74>&#39;utf-8&#39;</span>)
</span></span><span style=display:flex><span>    message[<span style=color:#e6db74>&#39;To&#39;</span>] <span style=color:#f92672>=</span> Header(<span style=color:#e6db74>&#34;我的收件邮箱&#34;</span>, <span style=color:#e6db74>&#39;utf-8&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    subject <span style=color:#f92672>=</span> date <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39; &#39;</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;XXXXXXX情况&#39;</span>
</span></span><span style=display:flex><span>    message[<span style=color:#e6db74>&#39;Subject&#39;</span>] <span style=color:#f92672>=</span> Header(subject, <span style=color:#e6db74>&#39;utf-8&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>        smtpObj <span style=color:#f92672>=</span> smtplib<span style=color:#f92672>.</span>SMTP()
</span></span><span style=display:flex><span>        smtpObj<span style=color:#f92672>.</span>connect(mail_host, <span style=color:#ae81ff>25</span>)  <span style=color:#75715e># 25 为 SMTP 端口号</span>
</span></span><span style=display:flex><span>        smtpObj<span style=color:#f92672>.</span>login(mail_user, mail_pass)
</span></span><span style=display:flex><span>        smtpObj<span style=color:#f92672>.</span>sendmail(sender, receivers, message<span style=color:#f92672>.</span>as_string())
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#34;邮件发送成功&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>except</span> smtplib<span style=color:#f92672>.</span>SMTPException <span style=color:#66d9ef>as</span> e:
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#34;Error: 无法发送邮件&#34;</span>)
</span></span><span style=display:flex><span>        print(repr(e))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>regular_res</span>(res):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    把不规则json转为规则json
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    :param res: 请求得到的字符串
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    :return: 合法的json字符串
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    res <span style=color:#f92672>=</span> re<span style=color:#f92672>.</span>sub(<span style=color:#e6db74>r</span><span style=color:#e6db74>&#39;\n&#39;</span>, <span style=color:#e6db74>&#39;&#39;</span>, res)
</span></span><span style=display:flex><span>    res <span style=color:#f92672>=</span> re<span style=color:#f92672>.</span>sub(<span style=color:#e6db74>r</span><span style=color:#e6db74>&#39;\t&#39;</span>, <span style=color:#e6db74>&#39;&#39;</span>, res)
</span></span><span style=display:flex><span>    res <span style=color:#f92672>=</span> re<span style=color:#f92672>.</span>sub(<span style=color:#e6db74>r</span><span style=color:#e6db74>&#39;chnldesc&#39;</span>, <span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>chnldesc</span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>&#39;</span>, res)
</span></span><span style=display:flex><span>    res <span style=color:#f92672>=</span> re<span style=color:#f92672>.</span>sub(<span style=color:#e6db74>r</span><span style=color:#e6db74>&#39;recordCount&#39;</span>, <span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>recordCount</span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>&#39;</span>, res)
</span></span><span style=display:flex><span>    res <span style=color:#f92672>=</span> re<span style=color:#f92672>.</span>sub(<span style=color:#e6db74>r</span><span style=color:#e6db74>&#39;docs&#39;</span>, <span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>docs</span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>&#39;</span>, res)
</span></span><span style=display:flex><span>    res <span style=color:#f92672>=</span> re<span style=color:#f92672>.</span>sub(<span style=color:#e6db74>r</span><span style=color:#e6db74>&#39;docid&#39;</span>, <span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>docid</span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>&#39;</span>, res)
</span></span><span style=display:flex><span>    res <span style=color:#f92672>=</span> re<span style=color:#f92672>.</span>sub(<span style=color:#e6db74>r</span><span style=color:#e6db74>&#39;title&#39;</span>, <span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>title</span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>&#39;</span>, res)
</span></span><span style=display:flex><span>    res <span style=color:#f92672>=</span> re<span style=color:#f92672>.</span>sub(<span style=color:#e6db74>r</span><span style=color:#e6db74>&#39;url&#39;</span>, <span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>url</span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>&#39;</span>, res)
</span></span><span style=display:flex><span>    res <span style=color:#f92672>=</span> re<span style=color:#f92672>.</span>sub(<span style=color:#e6db74>r</span><span style=color:#e6db74>&#39;time &#39;</span>, <span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>time</span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>&#39;</span>, res)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> res
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>crawl_data</span>(date):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    爬取文档
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    :param date: 日期，用于测量是否是当天的
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    :return: 目标页面的url
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    url <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;http://xxxxxxxxxx?r=&#39;</span> <span style=color:#f92672>+</span> str(random<span style=color:#f92672>.</span>random())
</span></span><span style=display:flex><span>    response <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>get(url, headers<span style=color:#f92672>=</span>headers)
</span></span><span style=display:flex><span>    res <span style=color:#f92672>=</span> str(response<span style=color:#f92672>.</span>content, encoding<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;utf-8&#39;</span>)
</span></span><span style=display:flex><span>    response<span style=color:#f92672>.</span>close()
</span></span><span style=display:flex><span>    res <span style=color:#f92672>=</span> regular_res(res)
</span></span><span style=display:flex><span>    json_obj <span style=color:#f92672>=</span> json<span style=color:#f92672>.</span>loads(res)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> doc <span style=color:#f92672>in</span> json_obj[<span style=color:#e6db74>&#39;docs&#39;</span>]:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> doc[<span style=color:#e6db74>&#39;title&#39;</span>] <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;XXXXXXXX情情况&#39;</span> <span style=color:#f92672>and</span> doc[<span style=color:#e6db74>&#39;time&#39;</span>] <span style=color:#f92672>==</span> date:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> doc[<span style=color:#e6db74>&#39;url&#39;</span>]
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#39;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>timestamp_to_date</span>(timestamp):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    时间戳转时间年-月-日
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    :param timestamp: 时间戳
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    :return: 时间字符串
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> time<span style=color:#f92672>.</span>strftime(time<span style=color:#f92672>.</span>strftime(<span style=color:#e6db74>&#34;%Y-%m-</span><span style=color:#e6db74>%d</span><span style=color:#e6db74>&#34;</span>, time<span style=color:#f92672>.</span>localtime(timestamp)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>crawl_content</span>(res_url):
</span></span><span style=display:flex><span>    response <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>get(res_url, headers<span style=color:#f92672>=</span>headers)
</span></span><span style=display:flex><span>    html <span style=color:#f92672>=</span> str(response<span style=color:#f92672>.</span>content, encoding<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;utf-8&#39;</span>)
</span></span><span style=display:flex><span>    response<span style=color:#f92672>.</span>close()
</span></span><span style=display:flex><span>    html_content <span style=color:#f92672>=</span> BeautifulSoup(html, <span style=color:#e6db74>&#39;lxml&#39;</span>)
</span></span><span style=display:flex><span>    news_content <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;</span>
</span></span><span style=display:flex><span>    news_block <span style=color:#f92672>=</span> html_content<span style=color:#f92672>.</span>select(<span style=color:#e6db74>&#39;div.TRS_Editor&#39;</span>)[<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span>    [s<span style=color:#f92672>.</span>extract() <span style=color:#66d9ef>for</span> s <span style=color:#f92672>in</span> html_content<span style=color:#f92672>.</span>select(<span style=color:#e6db74>&#39;style&#39;</span>)]
</span></span><span style=display:flex><span>    [s<span style=color:#f92672>.</span>extract() <span style=color:#66d9ef>for</span> s <span style=color:#f92672>in</span> html_content<span style=color:#f92672>.</span>select(<span style=color:#e6db74>&#39;script&#39;</span>)]
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> block <span style=color:#f92672>in</span> news_block<span style=color:#f92672>.</span>contents:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> isinstance(block, NavigableString):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>del</span> block[<span style=color:#e6db74>&#39;style&#39;</span>]
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>del</span> block[<span style=color:#e6db74>&#39;class&#39;</span>]
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>del</span> block[<span style=color:#e6db74>&#39;align&#39;</span>]
</span></span><span style=display:flex><span>            <span style=color:#75715e># print(block.name)</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> block<span style=color:#f92672>.</span>name <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;a&#39;</span>:
</span></span><span style=display:flex><span>                block[<span style=color:#e6db74>&#39;href&#39;</span>] <span style=color:#f92672>=</span> urljoin(res_url, block[<span style=color:#e6db74>&#39;href&#39;</span>])
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> block<span style=color:#f92672>.</span>name <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;h2&#39;</span> <span style=color:#f92672>or</span> block<span style=color:#f92672>.</span>get_text()<span style=color:#f92672>.</span>strip() <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;&#39;</span>:
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>        news_content <span style=color:#f92672>+=</span> str(block)<span style=color:#f92672>.</span>replace(<span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\r</span><span style=color:#e6db74>&#39;</span>, <span style=color:#e6db74>&#39;&#39;</span>)<span style=color:#f92672>.</span>replace(<span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#39;</span>, <span style=color:#e6db74>&#39;&#39;</span>)<span style=color:#f92672>.</span>replace(<span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\t</span><span style=color:#e6db74>&#39;</span>, <span style=color:#e6db74>&#39;&#39;</span>)<span style=color:#f92672>.</span>strip()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> news_content
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;__main__&#39;</span>:
</span></span><span style=display:flex><span>    <span style=color:#75715e># # 2.6的时间戳</span>
</span></span><span style=display:flex><span>    timestamp <span style=color:#f92672>=</span> <span style=color:#ae81ff>1580918400</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> (<span style=color:#66d9ef>True</span>):
</span></span><span style=display:flex><span>        <span style=color:#75715e># 每隔60秒爬一次</span>
</span></span><span style=display:flex><span>        time<span style=color:#f92672>.</span>sleep(<span style=color:#ae81ff>60</span>)
</span></span><span style=display:flex><span>        <span style=color:#75715e># 获取下次需要的日期</span>
</span></span><span style=display:flex><span>        date <span style=color:#f92672>=</span> timestamp_to_date(timestamp)
</span></span><span style=display:flex><span>        <span style=color:#75715e># 请求得到目标url</span>
</span></span><span style=display:flex><span>        res_url <span style=color:#f92672>=</span> crawl_data(date)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> res_url <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;&#39;</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># 找到相应的请求，爬取内容</span>
</span></span><span style=display:flex><span>        news_content <span style=color:#f92672>=</span> crawl_content(res_url)
</span></span><span style=display:flex><span>        <span style=color:#75715e># 发送邮件</span>
</span></span><span style=display:flex><span>        send_mail(date, news_content)
</span></span><span style=display:flex><span>        <span style=color:#75715e># 爬取下一天的内容</span>
</span></span><span style=display:flex><span>        timestamp <span style=color:#f92672>+=</span> <span style=color:#ae81ff>86400</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># 2.9之后停止</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> timestamp <span style=color:#f92672>==</span> <span style=color:#ae81ff>1581264000</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>
</span></span></code></pre></div><p>使用网易邮箱app，可以第一时间接到自己发的邮件。</p><p>这里测试过QQ邮箱，把我的邮件判定为垃圾邮件，直接被退回了。</p><p>测试结果：
<img loading=lazy src=/images/crawler_email_example.jpg alt>
（我做完然后发现爬不动的时候，感觉到了自己在吃人血馒头，故将人名隐去）</p><p>在本地测试通过后，放到服务器上，使用</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>nohup python3 main.py &amp;
</span></span></code></pre></div><p>放在后台执行，本以为万事大吉，结果才爬了一小会人报了错。</p><pre tabindex=0><code>ConnectionResetError: [Errno 104] Connection reset by peer
</code></pre><p>服务器把我的连接请求关闭了。</p><p>网上查找资料的结果是，爬取过频，对面关闭服务器我还继续请求。</p><p>但我一分钟请求一次，也不算特别快了。</p><p>我当然可以写个方法，在读取异常之后继续爬，如：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>request_while_response</span>(url, type, headers, data, open_proxy, sleep_time):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>   发送请求,规避10054错误，直至请求成功
</span></span></span><span style=display:flex><span><span style=color:#e6db74>   :param url: 请求路径
</span></span></span><span style=display:flex><span><span style=color:#e6db74>   :param type:  请求类型（get或post）
</span></span></span><span style=display:flex><span><span style=color:#e6db74>   :param headers: 请求头
</span></span></span><span style=display:flex><span><span style=color:#e6db74>   :param data: 请求参数对象
</span></span></span><span style=display:flex><span><span style=color:#e6db74>   :param open_proxy:  是否使用代理
</span></span></span><span style=display:flex><span><span style=color:#e6db74>   :return:  请求得到的文本
</span></span></span><span style=display:flex><span><span style=color:#e6db74>   &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    r <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:  <span style=color:#75715e># 循环</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>            <span style=color:#75715e># request()是发送请求的方法，我将requests包封装成了</span>
</span></span><span style=display:flex><span>            r <span style=color:#f92672>=</span> request(url, type, headers, data, open_proxy)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>except</span> (requests<span style=color:#f92672>.</span>exceptions<span style=color:#f92672>.</span>SSLError, requests<span style=color:#f92672>.</span>exceptions<span style=color:#f92672>.</span>ConnectionError, requests<span style=color:#f92672>.</span>exceptions<span style=color:#f92672>.</span>ReadTimeout) <span style=color:#66d9ef>as</span> e:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#e6db74>&#39;bad handshake&#39;</span> <span style=color:#f92672>in</span> str(e) <span style=color:#f92672>or</span> <span style=color:#e6db74>&#39;10054&#39;</span> <span style=color:#f92672>in</span> str(e) <span style=color:#f92672>or</span> <span style=color:#e6db74>&#39;Read timed out&#39;</span> <span style=color:#f92672>in</span> str(e):  <span style=color:#75715e># 上述2种异常</span>
</span></span><span style=display:flex><span>                time<span style=color:#f92672>.</span>sleep(sleep_time)
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>continue</span>  <span style=color:#75715e># 继续发请求</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>Exception</span>(e)  <span style=color:#75715e># 其他异常，抛出来</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>break</span>  <span style=color:#75715e># 无异常就跳出循环</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> r  <span style=color:#75715e># 返回响应结果</span>
</span></span></code></pre></div><p>但总归是做贼心虚，还是罢了。</p></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=prev href=https://windypath.com/posts/java_implement_winscp_like/><span class=title>« 上一页</span><br><span>Java实现类似WINSCP访问远程Linux服务器，执行命令、上传文件、下载文件</span></a>
<a class=next href=https://windypath.com/posts/python_connect_mongodb_and_oracle/><span class=title>下一页 »</span><br><span>Python连接MongoDB和Oracle实战</span></a></nav></footer></article></main><footer class=footer><span>Windypath 风萧古道 <strong>For Chinese Software</strong>. <a href=https://beian.miit.gov.cn/>闽ICP备15016446号-3</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a>
.</span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="复制";function s(){t.innerHTML="已复制！",setTimeout(()=>{t.innerHTML="复制"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>