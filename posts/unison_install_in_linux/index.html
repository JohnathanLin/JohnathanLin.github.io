<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Unison在Linux下的安装与使用 | 风萧古道 - 勤学苦练，年复一年</title><meta name=keywords content><meta name=description content="这是一篇在公司写的文档，但不涉及公司隐私。几乎所有内容参考于：https://www.cnblogs.com/welcomer/p/5068287.html
 引言 编写目的 编写本文档是为了让读者快速上手使用Unison进行两台Linux服务器文件进行同步。
前景 Unison是windows和unix平台下都可以使用的双向文件同步工具，它能使两个文件夹（本地或网络上的）保持内容的一致。 unison 拥有其它一些同步工具或文件系统的相同特性，但也有自己的特点：
 跨平台使用； 对内核和用户 权限 没有特别要求； unison 是双向的，它能自动 处理两分拷贝中更新没有冲突的部分，有冲突的部分将会显示出来让用户选择更新策略；  只要是能连通的两台主机 ，就可以运行 unison ，可以直接使用 socket 连接或安全的 ssh 连接方式，对带宽 的要求不高，使用类似 rsync 的压缩传输协议。
Unison双向同步的一个缺点是,对于同名文件在两个同步文件夹中都被修改时,unison是不会去同步的,因为unison无法判断以那个为准。
定义 本文档介绍如何同步两台服务器，为表述方便，将第一台服务器命名为“服务器1”，操作该服务器的用户为“system1”；将第二台服务器命名为“服务器2”，操作该服务器的用户命名为“system2”。
参考资料 《使用Unison同步服务器目录》 https://www.cnblogs.com/welcomer/p/5068287.html
安装与初始化 由于在目录同步时需要跨服务器通过ssh连接，因此不建议使用root用户，建议新建普通用户进行操作。
在两台或多台服务器之间同步，只需要在第一台服务器上安装Unison，再用scp连接将可执行的unison文件复制到第二台服务器上即可。
安装Unison 由于使用源码包安装Unison需要安装Ocaml依赖，且Unison默认将文件复制到“/用户名/bin/”目录下，会导致在make install步骤时提示错误，所以建议使用apt-get或yum安装。
Ubuntu下安装：在配置好阿里云的apt-get源之后，使用sudo apt-get install unison安装。
CentoOS下安装：使用yum install unison安装。
将Unison复制到服务器2 使用apt-get或yum安装Unison后，默认放在/usr/bin/unison。
1、使用ssh连接到远程主机：
scp /usr/bin/unison root@服务器2的IP地址:/root/ 注意：在Ubuntu下，如果服务器没有安装openssh-server，则无法被其他服务器连接，解决方法：
 使用sudo apt-get install openssh-server安装 在/etc/ssh/sshd_config文件中，把将PermitRootLogin prohibie-password 修改为：PermitRootLogin yes 重启ssh服务即可使用。  2、登录服务器2，使用复制命令，将可执行文件unison从/root/移到/usr/bin/下。
cp /root/unison /usr/bin/ 3、在两台服务器上都输入unison –version，查看是否安装成功。如果返回了版本号，则安装成功。"><meta name=author content="JohnathanLin"><link rel=canonical href=https://windypath.com/posts/unison_install_in_linux/><link crossorigin=anonymous href=/assets/css/stylesheet.min.48a18943c2fc15c38a372b8dde1f5e5dc0bc64fa6cb90f5a817d2f8c76b7f3ae.css integrity="sha256-SKGJQ8L8FcOKNyuN3h9eXcC8ZPpsuQ9agX0vjHa3864=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.2840b7fccd34145847db71a290569594bdbdb00047097f75d6495d162f5d7dff.js integrity="sha256-KEC3/M00FFhH23GikFaVlL29sABHCX911kldFi9dff8=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://windypath.com/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=https://windypath.com/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://windypath.com/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://windypath.com/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://windypath.com/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,o,i,a,t,n,s){e.GoogleAnalyticsObject=t,e[t]=e[t]||function(){(e[t].q=e[t].q||[]).push(arguments)},e[t].l=1*new Date,n=o.createElement(i),s=o.getElementsByTagName(i)[0],n.async=1,n.src=a,s.parentNode.insertBefore(n,s)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-123-45","auto"),ga("send","pageview"))</script><meta property="og:title" content="Unison在Linux下的安装与使用"><meta property="og:description" content="这是一篇在公司写的文档，但不涉及公司隐私。几乎所有内容参考于：https://www.cnblogs.com/welcomer/p/5068287.html
 引言 编写目的 编写本文档是为了让读者快速上手使用Unison进行两台Linux服务器文件进行同步。
前景 Unison是windows和unix平台下都可以使用的双向文件同步工具，它能使两个文件夹（本地或网络上的）保持内容的一致。 unison 拥有其它一些同步工具或文件系统的相同特性，但也有自己的特点：
 跨平台使用； 对内核和用户 权限 没有特别要求； unison 是双向的，它能自动 处理两分拷贝中更新没有冲突的部分，有冲突的部分将会显示出来让用户选择更新策略；  只要是能连通的两台主机 ，就可以运行 unison ，可以直接使用 socket 连接或安全的 ssh 连接方式，对带宽 的要求不高，使用类似 rsync 的压缩传输协议。
Unison双向同步的一个缺点是,对于同名文件在两个同步文件夹中都被修改时,unison是不会去同步的,因为unison无法判断以那个为准。
定义 本文档介绍如何同步两台服务器，为表述方便，将第一台服务器命名为“服务器1”，操作该服务器的用户为“system1”；将第二台服务器命名为“服务器2”，操作该服务器的用户命名为“system2”。
参考资料 《使用Unison同步服务器目录》 https://www.cnblogs.com/welcomer/p/5068287.html
安装与初始化 由于在目录同步时需要跨服务器通过ssh连接，因此不建议使用root用户，建议新建普通用户进行操作。
在两台或多台服务器之间同步，只需要在第一台服务器上安装Unison，再用scp连接将可执行的unison文件复制到第二台服务器上即可。
安装Unison 由于使用源码包安装Unison需要安装Ocaml依赖，且Unison默认将文件复制到“/用户名/bin/”目录下，会导致在make install步骤时提示错误，所以建议使用apt-get或yum安装。
Ubuntu下安装：在配置好阿里云的apt-get源之后，使用sudo apt-get install unison安装。
CentoOS下安装：使用yum install unison安装。
将Unison复制到服务器2 使用apt-get或yum安装Unison后，默认放在/usr/bin/unison。
1、使用ssh连接到远程主机：
scp /usr/bin/unison root@服务器2的IP地址:/root/ 注意：在Ubuntu下，如果服务器没有安装openssh-server，则无法被其他服务器连接，解决方法：
 使用sudo apt-get install openssh-server安装 在/etc/ssh/sshd_config文件中，把将PermitRootLogin prohibie-password 修改为：PermitRootLogin yes 重启ssh服务即可使用。  2、登录服务器2，使用复制命令，将可执行文件unison从/root/移到/usr/bin/下。
cp /root/unison /usr/bin/ 3、在两台服务器上都输入unison –version，查看是否安装成功。如果返回了版本号，则安装成功。"><meta property="og:type" content="article"><meta property="og:url" content="https://windypath.com/posts/unison_install_in_linux/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-02-22T14:19:06+08:00"><meta property="article:modified_time" content="2020-02-22T14:19:06+08:00"><meta property="og:site_name" content="Windypath"><meta name=twitter:card content="summary"><meta name=twitter:title content="Unison在Linux下的安装与使用"><meta name=twitter:description content="这是一篇在公司写的文档，但不涉及公司隐私。几乎所有内容参考于：https://www.cnblogs.com/welcomer/p/5068287.html
 引言 编写目的 编写本文档是为了让读者快速上手使用Unison进行两台Linux服务器文件进行同步。
前景 Unison是windows和unix平台下都可以使用的双向文件同步工具，它能使两个文件夹（本地或网络上的）保持内容的一致。 unison 拥有其它一些同步工具或文件系统的相同特性，但也有自己的特点：
 跨平台使用； 对内核和用户 权限 没有特别要求； unison 是双向的，它能自动 处理两分拷贝中更新没有冲突的部分，有冲突的部分将会显示出来让用户选择更新策略；  只要是能连通的两台主机 ，就可以运行 unison ，可以直接使用 socket 连接或安全的 ssh 连接方式，对带宽 的要求不高，使用类似 rsync 的压缩传输协议。
Unison双向同步的一个缺点是,对于同名文件在两个同步文件夹中都被修改时,unison是不会去同步的,因为unison无法判断以那个为准。
定义 本文档介绍如何同步两台服务器，为表述方便，将第一台服务器命名为“服务器1”，操作该服务器的用户为“system1”；将第二台服务器命名为“服务器2”，操作该服务器的用户命名为“system2”。
参考资料 《使用Unison同步服务器目录》 https://www.cnblogs.com/welcomer/p/5068287.html
安装与初始化 由于在目录同步时需要跨服务器通过ssh连接，因此不建议使用root用户，建议新建普通用户进行操作。
在两台或多台服务器之间同步，只需要在第一台服务器上安装Unison，再用scp连接将可执行的unison文件复制到第二台服务器上即可。
安装Unison 由于使用源码包安装Unison需要安装Ocaml依赖，且Unison默认将文件复制到“/用户名/bin/”目录下，会导致在make install步骤时提示错误，所以建议使用apt-get或yum安装。
Ubuntu下安装：在配置好阿里云的apt-get源之后，使用sudo apt-get install unison安装。
CentoOS下安装：使用yum install unison安装。
将Unison复制到服务器2 使用apt-get或yum安装Unison后，默认放在/usr/bin/unison。
1、使用ssh连接到远程主机：
scp /usr/bin/unison root@服务器2的IP地址:/root/ 注意：在Ubuntu下，如果服务器没有安装openssh-server，则无法被其他服务器连接，解决方法：
 使用sudo apt-get install openssh-server安装 在/etc/ssh/sshd_config文件中，把将PermitRootLogin prohibie-password 修改为：PermitRootLogin yes 重启ssh服务即可使用。  2、登录服务器2，使用复制命令，将可执行文件unison从/root/移到/usr/bin/下。
cp /root/unison /usr/bin/ 3、在两台服务器上都输入unison –version，查看是否安装成功。如果返回了版本号，则安装成功。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://windypath.com/posts/"},{"@type":"ListItem","position":2,"name":"Unison在Linux下的安装与使用","item":"https://windypath.com/posts/unison_install_in_linux/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Unison在Linux下的安装与使用","name":"Unison在Linux下的安装与使用","description":"这是一篇在公司写的文档，但不涉及公司隐私。几乎所有内容参考于：https://www.cnblogs.com/welcomer/p/5068287.html\n 引言 编写目的 编写本文档是为了让读者快速上手使用Unison进行两台Linux服务器文件进行同步。\n前景 Unison是windows和unix平台下都可以使用的双向文件同步工具，它能使两个文件夹（本地或网络上的）保持内容的一致。 unison 拥有其它一些同步工具或文件系统的相同特性，但也有自己的特点：\n 跨平台使用； 对内核和用户 权限 没有特别要求； unison 是双向的，它能自动 处理两分拷贝中更新没有冲突的部分，有冲突的部分将会显示出来让用户选择更新策略；  只要是能连通的两台主机 ，就可以运行 unison ，可以直接使用 socket 连接或安全的 ssh 连接方式，对带宽 的要求不高，使用类似 rsync 的压缩传输协议。\nUnison双向同步的一个缺点是,对于同名文件在两个同步文件夹中都被修改时,unison是不会去同步的,因为unison无法判断以那个为准。\n定义 本文档介绍如何同步两台服务器，为表述方便，将第一台服务器命名为“服务器1”，操作该服务器的用户为“system1”；将第二台服务器命名为“服务器2”，操作该服务器的用户命名为“system2”。\n参考资料 《使用Unison同步服务器目录》 https://www.cnblogs.com/welcomer/p/5068287.html\n安装与初始化 由于在目录同步时需要跨服务器通过ssh连接，因此不建议使用root用户，建议新建普通用户进行操作。\n在两台或多台服务器之间同步，只需要在第一台服务器上安装Unison，再用scp连接将可执行的unison文件复制到第二台服务器上即可。\n安装Unison 由于使用源码包安装Unison需要安装Ocaml依赖，且Unison默认将文件复制到“/用户名/bin/”目录下，会导致在make install步骤时提示错误，所以建议使用apt-get或yum安装。\nUbuntu下安装：在配置好阿里云的apt-get源之后，使用sudo apt-get install unison安装。\nCentoOS下安装：使用yum install unison安装。\n将Unison复制到服务器2 使用apt-get或yum安装Unison后，默认放在/usr/bin/unison。\n1、使用ssh连接到远程主机：\nscp /usr/bin/unison root@服务器2的IP地址:/root/ 注意：在Ubuntu下，如果服务器没有安装openssh-server，则无法被其他服务器连接，解决方法：\n 使用sudo apt-get install openssh-server安装 在/etc/ssh/sshd_config文件中，把将PermitRootLogin prohibie-password 修改为：PermitRootLogin yes 重启ssh服务即可使用。  2、登录服务器2，使用复制命令，将可执行文件unison从/root/移到/usr/bin/下。\ncp /root/unison /usr/bin/ 3、在两台服务器上都输入unison –version，查看是否安装成功。如果返回了版本号，则安装成功。","keywords":[],"articleBody":" 这是一篇在公司写的文档，但不涉及公司隐私。几乎所有内容参考于：https://www.cnblogs.com/welcomer/p/5068287.html\n 引言 编写目的 编写本文档是为了让读者快速上手使用Unison进行两台Linux服务器文件进行同步。\n前景 Unison是windows和unix平台下都可以使用的双向文件同步工具，它能使两个文件夹（本地或网络上的）保持内容的一致。 unison 拥有其它一些同步工具或文件系统的相同特性，但也有自己的特点：\n 跨平台使用； 对内核和用户 权限 没有特别要求； unison 是双向的，它能自动 处理两分拷贝中更新没有冲突的部分，有冲突的部分将会显示出来让用户选择更新策略；  只要是能连通的两台主机 ，就可以运行 unison ，可以直接使用 socket 连接或安全的 ssh 连接方式，对带宽 的要求不高，使用类似 rsync 的压缩传输协议。\nUnison双向同步的一个缺点是,对于同名文件在两个同步文件夹中都被修改时,unison是不会去同步的,因为unison无法判断以那个为准。\n定义 本文档介绍如何同步两台服务器，为表述方便，将第一台服务器命名为“服务器1”，操作该服务器的用户为“system1”；将第二台服务器命名为“服务器2”，操作该服务器的用户命名为“system2”。\n参考资料 《使用Unison同步服务器目录》 https://www.cnblogs.com/welcomer/p/5068287.html\n安装与初始化 由于在目录同步时需要跨服务器通过ssh连接，因此不建议使用root用户，建议新建普通用户进行操作。\n在两台或多台服务器之间同步，只需要在第一台服务器上安装Unison，再用scp连接将可执行的unison文件复制到第二台服务器上即可。\n安装Unison 由于使用源码包安装Unison需要安装Ocaml依赖，且Unison默认将文件复制到“/用户名/bin/”目录下，会导致在make install步骤时提示错误，所以建议使用apt-get或yum安装。\nUbuntu下安装：在配置好阿里云的apt-get源之后，使用sudo apt-get install unison安装。\nCentoOS下安装：使用yum install unison安装。\n将Unison复制到服务器2 使用apt-get或yum安装Unison后，默认放在/usr/bin/unison。\n1、使用ssh连接到远程主机：\nscp /usr/bin/unison root@服务器2的IP地址:/root/ 注意：在Ubuntu下，如果服务器没有安装openssh-server，则无法被其他服务器连接，解决方法：\n 使用sudo apt-get install openssh-server安装 在/etc/ssh/sshd_config文件中，把将PermitRootLogin prohibie-password 修改为：PermitRootLogin yes 重启ssh服务即可使用。  2、登录服务器2，使用复制命令，将可执行文件unison从/root/移到/usr/bin/下。\ncp /root/unison /usr/bin/ 3、在两台服务器上都输入unison –version，查看是否安装成功。如果返回了版本号，则安装成功。\n[root@服务器名 ~]$ unison -version  unison version 2.40.128 Unison的配置 配置ssh key信任 即配置公私钥。从这里开始，建议使用普通用户进行操作。\n新建普通用户  使用useradd –m 用户名 新建用户，再使用passwd 用户名 为用户设置密码。 使用 su 用户名 ，从root用户转到普通用户。  本文使用用户system1指代服务器1的用户，system2指代服务器2的用户。\n在服务器1上配置服务器2的信任 在服务器1新建ssh key 在服务器1的system1用户下，\n 使用命令 ssh-keygen –t rsa 命令生成公私钥，在提示保存私钥（key）和公钥（public key）的位置时，使用默认值； 在提示是否需要私钥密码（passphrase）时，直接敲回车，即不使用私钥密码。 系统将生成一对密钥，id_rsa（私钥文件）和id_rsa.pub（公钥文件），保存在/home/system1/.ssh/目录下。  将公钥添加到服务器2 1、将~/.ssh/id_rsa.pub公钥文件上传到服务器2\n[system1@服务器1~]$ scp ~/.ssh/id_rsa.pub system2@服务器2ip地址:/home/system2/ 2、使用system2登录服务器2\n（1）在~目录下新建文件夹.ssh，并使用chmod赋予权限\nmkdir .ssh chmod 700 .ssh （2）将刚才system1生成的公钥id_rsa.pub移动到刚才system2新建的.ssh目录下，并重命名为authorized_keys，并使用chmod赋予权限\nmv ~/id_rsa.pub ~/.ssh/authorized_keys  chmod 600 ~/.ssh/authorized_keys 至此，配置服务器1信任服务器2完成。\n在服务器2上配置服务器1的信任 执行方法与服务器1完全一致。在服务器2上，使用system2登录，然后使用ssh-keygen –t rsa 生成公私钥，使用scp复制公钥到服务器1的system1的~目录下，在服务器1上将服务器2的id_rsa.pub公钥移动到~/.ssh/下并改名为authorized_keys。\n重启ssh服务 在两台服务器上分别使用如下命令以重启ssh服务。\n/etc/init.d/ssh stop  /etc/init.d/ssh start Unison配置文件 新建测试目录 在两个服务器的~目录下分别新建test目录，此目录将作为之后被同步的目录。\n[system1@服务器1 ~]$ mkdir test [system2@服务器2 ~]$ mkdir test 首次使用Unison同步 在两台服务器上分别执行一次unison，如果出现提示确认，则直接敲回车选择默认值。\n[system1@服务器1~]$unison /home/system1/test/ ssh://system2@服务器2//home/system2/test/ [system2@服务器2~]$unison /home/system2/test/ ssh://system1@服务器1//home/system1/test/ 在首次同步之后，Unison会在用户的~目录下新建一个.unison目录，里面会有一个default.prf，这是unison同步的配置文件，编辑这个文件，之后就可以直接使用unison命令执行同步。\n编辑配置文件default.prf 对服务器1的default.prf进行如下编辑：\n#Unison preferences file root = /home/system1/test root = ssh://system2@服务器2//home/system2/test/ #force = #ignore = batch = true #repeat = 1 #retry = 3 #owner = true #group = true perms = -1 fastcheck = false rsync = false sshargs = -C xferbycopying = true log = true logfile = /home/system1/.unison/unison.log 对服务器2的default.prf进行如下编辑：\n#Unison preferences file root = /home/system2/test root = ssh://system1@服务器1//home/system1/test/ #force = #ignore = batch = true #repeat = 1 #retry = 3 #owner = true #group = true perms = -1 fastcheck = false rsync = false sshargs = -C xferbycopying = true log = true logfile = /home/system2/.unison/unison.log 相关注解如下：\nforce表示会以本地所指定文件夹为标准，将该目录同步到远端。这里需要注意，如果指定了force参数，那么Unison就变成了单项同步了，也就是说会以force指定的文件夹为准进行同步，类似与rsync。\nUnison双向同步基本原理是：假如有A B两个文件夹，A文件夹把自己的改动同步到B，B文件夹也把自己的改动同步到A，最后A B两文件夹的内容相同，是AB文件夹的合集。\nUnison双向同步的一个缺点是，对于一个文件在两个同步文件夹中都被修改时，unison是不会去同步的，因为unison无法判断以那个为准。\nignore = Path表示忽略指定目录，即同步时不同步它。\nbatch = true，表示全自动模式，接受缺省动作，并执行。\n-fastcheck true 表示同步时仅通过文件的创建时间来比较，如果选项为false，Unison则将比较两地文件的内容。\nlog = true 表示在终端输出运行信息。\nlogfile 指定输出的log文件。\n运行 执行unison命令进行同步 在终端下，直接输入命令unison即可同步。\n在没有发生更改时，运行的结果为：\n在目标目录test下有文件发生改变时，运行结果为： 设置定时任务自动同步 使用crontab进行自动同步。\n(1)使用crontab –e 命令编辑定时任务。 (2)在文件最后一行输入cron表达式 + 要执行的命令，如果要每分钟执行一次同步，则输入：\n* * * * * unison 然后按下ctrl+O，会提示保存，按回车确认保存；\n最后按下ctrl+X退出。\n(3)在终端输入crontab –l 查看当前正在运行的定时任务 ","wordCount":"300","inLanguage":"en","datePublished":"2020-02-22T14:19:06+08:00","dateModified":"2020-02-22T14:19:06+08:00","author":{"@type":"Person","name":"JohnathanLin"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://windypath.com/posts/unison_install_in_linux/"},"publisher":{"@type":"Organization","name":"风萧古道 - 勤学苦练，年复一年","logo":{"@type":"ImageObject","url":"https://windypath.com/%3Clink%20/%20abs%20url%3E"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://windypath.com/ accesskey=h title="Windypath (Alt + H)">Windypath</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://windypath.com/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://windypath.com/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://windypath.com/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://windypath.com/>Home</a>&nbsp;»&nbsp;<a href=https://windypath.com/posts/>Posts</a></div><h1 class=post-title>Unison在Linux下的安装与使用</h1><div class=post-meta><span title="2020-02-22 14:19:06 +0800 +0800">February 22, 2020</span>&nbsp;·&nbsp;2 min&nbsp;·&nbsp;JohnathanLin&nbsp;|&nbsp;<a href=https://github.com/%3cpath_to_repo%3e/content/posts/unison_install_in_linux.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=post-content><blockquote><p>这是一篇在公司写的文档，但不涉及公司隐私。几乎所有内容参考于：<a href=https://www.cnblogs.com/welcomer/p/5068287.html>https://www.cnblogs.com/welcomer/p/5068287.html</a></p></blockquote><h2 id=引言>引言<a hidden class=anchor aria-hidden=true href=#引言>#</a></h2><h3 id=编写目的>编写目的<a hidden class=anchor aria-hidden=true href=#编写目的>#</a></h3><p>编写本文档是为了让读者快速上手使用Unison进行两台Linux服务器文件进行同步。</p><h2 id=前景>前景<a hidden class=anchor aria-hidden=true href=#前景>#</a></h2><p>Unison是windows和unix平台下都可以使用的双向文件同步工具，它能使两个文件夹（本地或网络上的）保持内容的一致。 unison 拥有其它一些同步工具或文件系统的相同特性，但也有自己的特点：</p><ol><li>跨平台使用；</li><li>对内核和用户 权限 没有特别要求；</li><li>unison 是双向的，它能自动 处理两分拷贝中更新没有冲突的部分，有冲突的部分将会显示出来让用户选择更新策略；</li></ol><p>只要是能连通的两台主机 ，就可以运行 unison ，可以直接使用 socket 连接或安全的 ssh 连接方式，对带宽 的要求不高，使用类似 rsync 的压缩传输协议。</p><p>Unison双向同步的一个缺点是,对于同名文件在两个同步文件夹中都被修改时,unison是不会去同步的,因为unison无法判断以那个为准。</p><h3 id=定义>定义<a hidden class=anchor aria-hidden=true href=#定义>#</a></h3><p>本文档介绍如何同步两台服务器，为表述方便，将第一台服务器命名为“服务器1”，操作该服务器的用户为“system1”；将第二台服务器命名为“服务器2”，操作该服务器的用户命名为“system2”。</p><h3 id=参考资料>参考资料<a hidden class=anchor aria-hidden=true href=#参考资料>#</a></h3><p>《使用Unison同步服务器目录》 <a href=https://www.cnblogs.com/welcomer/p/5068287.html>https://www.cnblogs.com/welcomer/p/5068287.html</a></p><h2 id=安装与初始化>安装与初始化<a hidden class=anchor aria-hidden=true href=#安装与初始化>#</a></h2><p>由于在目录同步时需要跨服务器通过ssh连接，因此不建议使用root用户，建议新建普通用户进行操作。</p><p>在两台或多台服务器之间同步，只需要在第一台服务器上安装Unison，再用scp连接将可执行的unison文件复制到第二台服务器上即可。</p><h3 id=安装unison>安装Unison<a hidden class=anchor aria-hidden=true href=#安装unison>#</a></h3><p>由于使用源码包安装Unison需要安装Ocaml依赖，且Unison默认将文件复制到“/用户名/bin/”目录下，会导致在make install步骤时提示错误，所以建议使用apt-get或yum安装。</p><p><strong>Ubuntu下安装</strong>：在配置好阿里云的apt-get源之后，使用sudo apt-get install unison安装。</p><p><strong>CentoOS下安装</strong>：使用yum install unison安装。</p><h3 id=将unison复制到服务器2>将Unison复制到服务器2<a hidden class=anchor aria-hidden=true href=#将unison复制到服务器2>#</a></h3><p>使用apt-get或yum安装Unison后，默认放在/usr/bin/unison。</p><p>1、使用ssh连接到远程主机：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>scp /usr/bin/unison root@服务器2的IP地址:/root/
</span></span></code></pre></div><p>注意：在Ubuntu下，如果服务器没有安装openssh-server，则无法被其他服务器连接，解决方法：</p><ol><li>使用sudo apt-get install openssh-server安装</li><li>在/etc/ssh/sshd_config文件中，把将PermitRootLogin prohibie-password 修改为：PermitRootLogin yes</li><li>重启ssh服务即可使用。</li></ol><p>2、登录服务器2，使用复制命令，将可执行文件unison从/root/移到/usr/bin/下。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cp /root/unison /usr/bin/
</span></span></code></pre></div><p>3、在两台服务器上都输入unison –version，查看是否安装成功。如果返回了版本号，则安装成功。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@服务器名 ~<span style=color:#f92672>]</span>$ unison -version 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>unison version 2.40.128
</span></span></code></pre></div><h2 id=unison的配置>Unison的配置<a hidden class=anchor aria-hidden=true href=#unison的配置>#</a></h2><h3 id=配置sshkey信任>配置ssh key信任<a hidden class=anchor aria-hidden=true href=#配置sshkey信任>#</a></h3><p>即配置公私钥。从这里开始，建议使用普通用户进行操作。</p><h4 id=新建普通用户>新建普通用户<a hidden class=anchor aria-hidden=true href=#新建普通用户>#</a></h4><ol><li>使用useradd –m 用户名 新建用户，再使用passwd 用户名 为用户设置密码。</li><li>使用 su 用户名 ，从root用户转到普通用户。</li></ol><p>本文使用用户system1指代服务器1的用户，system2指代服务器2的用户。</p><h4 id=在服务器1上配置服务器2的信任>在服务器1上配置服务器2的信任<a hidden class=anchor aria-hidden=true href=#在服务器1上配置服务器2的信任>#</a></h4><h5 id=在服务器1新建sshkey>在服务器1新建ssh key<a hidden class=anchor aria-hidden=true href=#在服务器1新建sshkey>#</a></h5><p>在服务器1的system1用户下，</p><ol><li>使用命令 ssh-keygen –t rsa 命令生成公私钥，在提示保存私钥（key）和公钥（public key）的位置时，使用默认值；</li><li>在提示是否需要私钥密码（passphrase）时，直接敲回车，即不使用私钥密码。</li><li>系统将生成一对密钥，id_rsa（私钥文件）和id_rsa.pub（公钥文件），保存在/home/system1/.ssh/目录下。</li></ol><h5 id=将公钥添加到服务器2>将公钥添加到服务器2<a hidden class=anchor aria-hidden=true href=#将公钥添加到服务器2>#</a></h5><p>1、将~/.ssh/id_rsa.pub公钥文件上传到服务器2</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>system1@服务器1~<span style=color:#f92672>]</span>$ scp ~/.ssh/id_rsa.pub system2@服务器2ip地址:/home/system2/
</span></span></code></pre></div><p>2、使用system2登录服务器2</p><p>（1）在~目录下新建文件夹.ssh，并使用chmod赋予权限</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>mkdir .ssh 
</span></span><span style=display:flex><span>chmod <span style=color:#ae81ff>700</span> .ssh
</span></span></code></pre></div><p>（2）将刚才system1生成的公钥id_rsa.pub移动到刚才system2新建的.ssh目录下，并重命名为authorized_keys，并使用chmod赋予权限</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>mv ~/id_rsa.pub ~/.ssh/authorized_keys
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>chmod <span style=color:#ae81ff>600</span> ~/.ssh/authorized_keys
</span></span></code></pre></div><p>至此，配置服务器1信任服务器2完成。</p><h4 id=在服务器2上配置服务器1的信任>在服务器2上配置服务器1的信任<a hidden class=anchor aria-hidden=true href=#在服务器2上配置服务器1的信任>#</a></h4><p>执行方法与服务器1完全一致。在服务器2上，使用system2登录，然后使用ssh-keygen –t rsa 生成公私钥，使用scp复制公钥到服务器1的system1的~目录下，在服务器1上将服务器2的id_rsa.pub公钥移动到~/.ssh/下并改名为authorized_keys。</p><h4 id=重启ssh服务>重启ssh服务<a hidden class=anchor aria-hidden=true href=#重启ssh服务>#</a></h4><p>在两台服务器上分别使用如下命令以重启ssh服务。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>/etc/init.d/ssh stop 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>/etc/init.d/ssh start
</span></span></code></pre></div><h3 id=unison配置文件> Unison配置文件<a hidden class=anchor aria-hidden=true href=#unison配置文件>#</a></h3><h4 id=新建测试目录>新建测试目录<a hidden class=anchor aria-hidden=true href=#新建测试目录>#</a></h4><p>在两个服务器的~目录下分别新建test目录，此目录将作为之后被同步的目录。</p><pre tabindex=0><code>[system1@服务器1 ~]$ mkdir test 

[system2@服务器2 ~]$ mkdir test
</code></pre><h4 id=首次使用unison同步>首次使用Unison同步<a hidden class=anchor aria-hidden=true href=#首次使用unison同步>#</a></h4><p>在两台服务器上分别执行一次unison，如果出现提示确认，则直接敲回车选择默认值。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>system1@服务器1~<span style=color:#f92672>]</span>$unison /home/system1/test/ ssh://system2@服务器2//home/system2/test/
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>system2@服务器2~<span style=color:#f92672>]</span>$unison /home/system2/test/ ssh://system1@服务器1//home/system1/test/
</span></span></code></pre></div><p>在首次同步之后，Unison会在用户的~目录下新建一个.unison目录，里面会有一个default.prf，这是unison同步的配置文件，编辑这个文件，之后就可以直接使用unison命令执行同步。</p><h4 id=编辑配置文件defaultprf>编辑配置文件default.prf<a hidden class=anchor aria-hidden=true href=#编辑配置文件defaultprf>#</a></h4><p>对服务器1的default.prf进行如下编辑：</p><pre tabindex=0><code>#Unison preferences file 
root = /home/system1/test 
root = ssh://system2@服务器2//home/system2/test/ 
#force = 
#ignore = 
batch = true 
#repeat = 1 
#retry = 3 
#owner = true 
#group = true 
perms = -1 
fastcheck = false
rsync = false 
sshargs = -C 
xferbycopying = true 
log = true 
logfile = /home/system1/.unison/unison.log
</code></pre><p>对服务器2的default.prf进行如下编辑：</p><pre tabindex=0><code>#Unison preferences file 
root = /home/system2/test 
root = ssh://system1@服务器1//home/system1/test/ 
#force = 
#ignore = 
batch = true 
#repeat = 1 
#retry = 3 
#owner = true 
#group = true 
perms = -1 
fastcheck = false 
rsync = false 
sshargs = -C 
xferbycopying = true 
log = true logfile = /home/system2/.unison/unison.log
</code></pre><p>相关注解如下：</p><p>force表示会以本地所指定文件夹为标准，将该目录同步到远端。这里需要注意，如果指定了force参数，那么Unison就变成了单项同步了，也就是说会以force指定的文件夹为准进行同步，类似与rsync。</p><p>Unison双向同步基本原理是：假如有A B两个文件夹，A文件夹把自己的改动同步到B，B文件夹也把自己的改动同步到A，最后A B两文件夹的内容相同，是AB文件夹的合集。</p><p>Unison双向同步的一个缺点是，对于一个文件在两个同步文件夹中都被修改时，unison是不会去同步的，因为unison无法判断以那个为准。</p><p>ignore = Path表示忽略指定目录，即同步时不同步它。</p><p>batch = true，表示全自动模式，接受缺省动作，并执行。</p><p>-fastcheck true 表示同步时仅通过文件的创建时间来比较，如果选项为false，Unison则将比较两地文件的内容。</p><p>log = true 表示在终端输出运行信息。</p><p>logfile 指定输出的log文件。</p><h2 id=运行>运行<a hidden class=anchor aria-hidden=true href=#运行>#</a></h2><h3 id=执行unison命令进行同步>执行unison命令进行同步<a hidden class=anchor aria-hidden=true href=#执行unison命令进行同步>#</a></h3><p>在终端下，直接输入命令unison即可同步。</p><p>在没有发生更改时，运行的结果为：</p><p><img loading=lazy src=/images/unison1.png alt>
在目标目录test下有文件发生改变时，运行结果为：
<img loading=lazy src=/images/unison2.png alt></p><h3 id=设置定时任务自动同步>设置定时任务自动同步<a hidden class=anchor aria-hidden=true href=#设置定时任务自动同步>#</a></h3><p>使用crontab进行自动同步。</p><p>(1)使用crontab –e 命令编辑定时任务。
<img loading=lazy src=/images/unison3.png alt></p><p>(2)在文件最后一行输入cron表达式 + 要执行的命令，如果要每分钟执行一次同步，则输入：</p><pre tabindex=0><code>* * * * * unison
</code></pre><p>然后按下ctrl+O，会提示保存，按回车确认保存；</p><p>最后按下ctrl+X退出。</p><p>(3)在终端输入crontab –l 查看当前正在运行的定时任务
<img loading=lazy src=/images/unison4.png alt></p></div><footer class=post-footer><nav class=paginav><a class=prev href=https://windypath.com/posts/spring_operate_mongodb/><span class=title>« Prev Page</span><br><span>Springboot操作MongoDB，包括增改查及复杂操作</span></a>
<a class=next href=https://windypath.com/posts/java_implement_winscp_like/><span class=title>Next Page »</span><br><span>Java实现类似WINSCP访问远程Linux服务器，执行命令、上传文件、下载文件</span></a></nav></footer></article></main><footer class=footer><span>Windypath 风萧古道 <a href=https://beian.miit.gov.cn/>闽ICP备15016446号-3</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>